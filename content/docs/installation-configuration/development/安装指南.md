+++
title = "安装指南"
description = ""
weight = 5
banner = "img/banners/banner-1.jpg"
+++

# 开发区安装指南

> 由于开发区各服务也需要进行更新和管理，所以将部署开发区和部署区的所有服务。本文以CentOS为例进行讲解。

## 搭建所需软件及文件

- 在要执行ansible脚本的机器上安装ansible运行需要的环境以及git。

    ```
    sudo yum install -y epel-release && \
    sudo yum install -y ansible git
    ```

- 克隆安装脚本
    ```
    git clone https://rdc.hand-china.com/gitlab/rdc_hip/devops-ansible.git
    ```

## 使用NFS存储

> 若选择其他存储方式或已有NFS Server请跳过此步。

1. 复制搭建K8S集群时所用到的`inventory/hosts`文件内容到本项目的`inventory/hosts`文件中。添加`[nfs]`分区，该分区只能添加一个节点，`[nfs]`分区节点即为提供nfs服务的节点。
1. 修改`inventory/vars.yml`文件，将不需要部署的资源`enable`置为`false`，这里会自动创建所需目录；请设置`nfs.ip`属性，默认为指定节点ipv4地址；计算包含所有各节点的子网掩码将值赋予`nfs.client_net`，默认为"*"即所有主机都可以访问。
1. 执行以下命令搭建nfs

    ```
    ansible-playbook -i inventory/hosts -e @inventory/vars.yml nfs-server.yml
    ```

## 部署开发区

1. 修改`inventory/hosts`文件，其中`[dev]`分区只能添加一个节点且该节点可以使用`kubectl`命令。
1. 确认所要部署的资源(mysql、rabbitmq、redis、zookeeper、kafka、sonarqube,minio),若资源已有不需要部署，请在`inventory/vars.yml`文件中将资源`enable`置为`false`。
1. 执行以下命令搭建开发区所需资源

    ```
    ansible-playbook -i  inventory/hosts -e @inventory/vars.yml dev-resource.yml
    ```
1. 手动部署harbor(外部数据库要手工初始化)[参考链接](https://rdc.hand-china.com/gitlab/rdc_hip/devops-install-docs/tree/master/devops/harbor)
1. 手动部署Gitlab，等Devops所有服务部署后再配置oauth授权(Mysql 5.6需要转表)[参考链接](https://rdc.hand-china.com/gitlab/rdc_hip/devops-install-docs/tree/master/devops/gitlab-ce)
    > 搭建完成Gitlab完成后创建一个名为`template`的Public Group，将`http://git.choerodon.com.cn/template`库中所有的仓科克隆并推送到新搭建的Gitlab仓库中,注意这个git库也应是public的，这样开发服务才能正常使用。
1. 手动部署Gitlab Runner[参考链接](https://rdc.hand-china.com/gitlab/rdc_hip/devops-install-docs/tree/master/devops/gitlab-runner)
1. 配置SonarQube[参考链接](https://rdc.hand-china.com/gitlab/rdc_hip/devops-install-docs/tree/master/devops/middleware/sonarqube#%E9%9B%86%E6%88%90gitlab)
1. 部署监控
    - 在`vars.yml`定义监控参数，并在指定的节点创建目录`/etc/monitoring/alertmanager/data`，并赋777权限。执行以下命令开始搭建。

    ```
    ansible-playbook -i  inventory/hosts -e @inventory/vars.yml monitoring.yml
    ```
1. 部署日志
    - 在`vars.yml`定义日志参数，并在指定的节点创建目录`/etc/logging/es-data`，授予777权限，执行以下命令开始搭建。

    ```
    ansible-playbook -i  inventory/hosts -e @inventory/vars.yml logging.yml
    ```
1. 创建开发区所需数据库
    - 若使用容器运行的mysql，可以参照以下命令进入容器创建数据库

    ```
    查看pod名称，进入容器
    kubectl get po -n devops
    kubectl exec -it [PodName] -n devops bash
    进入mysql命令行
    mysql -uroot -p${MYSQL_ROOT_PASSWORD}
    ```
    - 创建hapcloud用户及数据库

    ```sql
    CREATE USER 'hapcloud'@'%' IDENTIFIED BY 'Handhand123';
    CREATE DATABASE hap_user_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE hap_manager_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE hap_event_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE hap_framework_service DEFAULT CHARACTER SET utf8;
    GRANT ALL PRIVILEGES ON hap_user_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON hap_manager_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON hap_event_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON hap_framework_service.* TO hapcloud@'%';
    CREATE DATABASE hap_devops_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE devops_portal DEFAULT CHARACTER SET utf8;
    CREATE DATABASE hap_kanban_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE devops_operation_portal DEFAULT CHARACTER SET utf8;
    CREATE DATABASE devops_deploy_service DEFAULT CHARACTER SET utf8;
    CREATE DATABASE mobile_cloud_service DEFAULT CHARACTER SET utf8;
    GRANT ALL PRIVILEGES ON hap_devops_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON devops_portal.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON hap_kanban_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON devops_operation_portal.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON devops_deploy_service.* TO hapcloud@'%';
    GRANT ALL PRIVILEGES ON mobile_cloud_service.* TO hapcloud@'%';
    FLUSH PRIVILEGES;
    ```
1. 修改`inventory/config.yml`文件中资源区域维护好相应参数。
1. 执行以下命令开始开发区

    ```
    ansible-playbook -i  inventory/hosts -e @inventory/config.yml dev.yml
    ```